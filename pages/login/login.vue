<template>
	<view class="template-login">
		<!-- 顶部自定义导航 -->
		<!-- 		<tn-nav-bar fixed alpha customBack>
			<view slot="back" class='tn-custom-nav-bar__back' @click="goBack">
				<text class='icon tn-icon-left'></text>
				<text class='icon tn-icon-home-capsule-fill'></text>
			</view>
		</tn-nav-bar> -->

		<view class="login">
			<!-- 顶部背景图片-->
			<view class="login__bg login__bg--top">
				<image class="bg" src="@/static/login-top2.png" mode="widthFix"></image>
			</view>

			<view class="login__wrapper">
				<view class="tn-margin-left tn-margin-right tn-text-bold" style="font-size: 60rpx;">
					欢迎回来
				</view>
				<view class="tn-margin tn-color-gray--disabled tn-text-lg">
				</view>

				<!-- 输入框内容-->
				<view class="login__info tn-flex tn-flex-direction-column tn-flex-col-center tn-flex-row-center">
					<!-- 登录 -->
					<block v-if="currentModeIndex == 0">
						<view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-phone"></view>
							</view>
							<view class="login__info__item__input__content">
								<input maxlength="11" placeholder-class="input-placeholder" v-model="mobile"
									placeholder="请输入手机号" />
							</view>
						</view>

						<view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-safe"></view>
							</view>
							<view
								class="login__info__item__input__content login__info__item__input__content--verify-code">
								<input type="password" v-model="password" placeholder-class="input-placeholder"
									placeholder="请输入密码" />
							</view>

						</view>
					</block>
					<!-- 注册 -->
					<block v-if="currentModeIndex == 1">
						<view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-my-lack"></view>
							</view>
							<view class="login__info__item__input__content">
								<input maxlength="20" placeholder-class="input-placeholder" placeholder="邀请码(非必填)"
									v-model="code" />
							</view>
						</view>
						<view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-my-lack"></view>
							</view>
							<view class="login__info__item__input__content">
								<input maxlength="20" placeholder-class="input-placeholder" placeholder="请输入用户昵称"
									v-model="username" />
							</view>
						</view>
						<view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-phone"></view>
							</view>
							<view class="login__info__item__input__content">
								<input maxlength="11" type="number" placeholder-class="input-placeholder"
									placeholder="请输入手机号" v-model="mobile" />
							</view>
						</view>

						<!-- <view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-safe"></view>
							</view>
							<view
								class="login__info__item__input__content login__info__item__input__content--verify-code">
								<input v-model="code" placeholder-class="input-placeholder" placeholder="请输入验证码" />
							</view>
							<view class="login__info__item__input__right-verify-code" @tap.stop="getCode">
								<tn-button backgroundColor="#01BEFF" fontColor="#FFFFFF" size="sm" padding="5rpx 10rpx"
									width="100%" shape="round">{{ tips }}</tn-button>
							</view>
						</view> -->
						<view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-lock"></view>
							</view>
							<view class="login__info__item__input__content">
								<input :password="!showPassword" v-model="password"
									placeholder-class="input-placeholder" placeholder="请确认登录密码" />
							</view>
							<view class="login__info__item__input__right-icon" @click="showPassword = !showPassword">
								<view :class="[showPassword ? 'tn-icon-eye' : 'tn-icon-eye-hide']"></view>
							</view>
						</view>
						<view
							class="login__info__item__input tn-flex tn-flex-direction-row tn-flex-nowrap tn-flex-col-center tn-flex-row-left">
							<view class="login__info__item__input__left-icon">
								<view class="tn-icon-lock"></view>
							</view>
							<view class="login__info__item__input__content">
								<input :password="!showPassword_s" v-model="password_s"
									placeholder-class="input-placeholder" placeholder="请确认登录密码" />
							</view>
							<view class="login__info__item__input__right-icon"
								@click="showPassword_s = !showPassword_s">
								<view :class="[showPassword_s ? 'tn-icon-eye' : 'tn-icon-eye-hide']"></view>
							</view>
						</view>
					</block>
					<view class="login__info__item__button tn-bg-blue tn-color-white" hover-class="tn-hover"
						:hover-stay-time="150" @click="userLogin(currentModeIndex)">
						{{ currentModeIndex == 0 ? '登录' : '注册'}}
					</view>
					<view v-if="currentModeIndex == 1" :class="[{'login__info__item__tips': currentModeIndex == 0}]">
						<view class="tn-flex tn-flex-row-between tn-padding">
							<view class="" @tap.stop="modeSwitch(0)">前往登录</view>
						</view>
					</view>
					<view v-if="currentModeIndex == 0" :class="[{'login__info__item__tips': currentModeIndex == 1}]">
						<view class="tn-flex tn-flex-row-between tn-padding">
							<view class="tn-padding-right" @tap.stop="modeSwitch(1)">账号注册</view>
							<view class="tn-padding-left tn-color-gray">忘记密码</view>
						</view>
					</view>

				</view>
			</view>

			<!-- 底部背景图片-->
			<view class="login__bg login__bg--bottom">
				<image src="@/static/login-bottom2.png" mode="widthFix"></image>
			</view>

		</view>

		<!-- 验证码倒计时 -->
		<tn-verification-code ref="code" uniqueKey="login-demo-4" :seconds="60" @change="codeChange">
		</tn-verification-code>
	</view>
</template>

<script>
	// import template_page_mixin from '@/libs/mixin/template_page_mixin.js'
	import {
		login,
		useRes
	} from '@/commit/api.js';
	import {
		mapMutations
	} from 'vuex';
	export default {
		name: 'login-demo-4',
		// mixins: [template_page_mixin],
		data() {
			return {
				// 当前选中的模式
				currentModeIndex: 0,
				// 模式选中滑块
				modeSliderStyle: {
					left: 0
				},
				// 是否显示密码
				showPassword: false,
				showPassword_s: false,
				// 倒计时提示文字
				tips: '获取验证码',
				username: '',
				mobile: '',
				password: '',
				password_s: '',
				needPermission: false,
				code: ''
			}
		},
		onLoad(e) {
			this.currentModeIndex = e.type || 0
			if (!e.code) {
				return false
			} else {
				this.code = e.code
			}


		},
		watch: {
			currentModeIndex(value) {
				const sliderWidth = uni.upx2px(476 / 2)
				this.modeSliderStyle.left = `${sliderWidth * value}px`
			}
		},
		methods: {
			...mapMutations(['login']),
			userLogin(n) {
				if (n == 0) {
					if (!this.mobile || !this.password) {
						uni.showToast({
							title: '账号或密码不能为空',
							icon: 'none'
						})
						return false;
					}
					login({
						mobile: this.mobile,
						pwd: this.password
					}).then((res) => {
						this.login(res)
						uni.reLaunch({
							url: '/pages/index/index',
							fail(e) {
								console.log(e)
							}
						})
					})
				} else {
					if (this.username == '') {
						uni.showToast({
							title: '请输入昵称',
							icon: 'none'
						})
						return
					}
					if (this.mobile == '') {
						uni.showToast({
							title: '请输入手机号',
							icon: 'none'
						})
						return
					}
					if (this.password != this.password_s) {
						uni.showToast({
							title: '两次输入的密码不一致',
							icon: 'none'
						})
						return
					}
					useRes({
						mobile: this.mobile,
						pwd: this.password,
						name: this.username,
						invtNum: Number(this.code) || ''
					}).then((res) => {
						if (res.code == 200) {
							uni.showToast({
								title: '注册成功',
								icon: 'none'
							})
							setTimeout(() => {
								this.modeSwitch(0)
							}, 2000)
						} else {
							uni.showToast({
								title: res.msg,
								icon: 'none'
							})
						}

					})
				}
			},
			// 切换模式
			modeSwitch(index) {
				this.currentModeIndex = index
				this.showPassword = false
			},
			// 获取验证码
			getCode() {
				if (this.$refs.code.canGetCode) {
					this.$tn.message.loading('正在获取验证码')
					setTimeout(() => {
						this.$tn.message.closeLoading()
						this.$tn.message.toast('验证码已经发送')
						// 通知组件开始计时
						this.$refs.code.start()
					}, 2000)
				} else {
					this.$tn.message.toast(this.$refs.code.secNum + '秒后再重试')
				}
			},
			// 获取验证码倒计时被修改
			codeChange(event) {
				this.tips = event
			}
		}
	}
</script>

<style lang="scss" scoped>
	@import '@/static/publit.css';

	.login {
		position: relative;
		height: 100%;
		z-index: 1;
	}


	.login__bg--bottom {
		bottom: -10rpx;
		left: 0;
		right: 0;
		width: 100%;
		margin-bottom: env(safe-area-inset-bottom);
	}

	.login__bg--bottom image {
		width: 750rpx;
		will-change: transform;
	}

	.login__wrapper {
		margin-top: 200rpx;
		width: 100%;
	}

	.login__mode {
		position: relative;
		margin: 0 auto;
		width: 476rpx;
		height: 77rpx;
		margin-top: 100rpx;
		background-color: rgba(255, 255, 255, 0.6);
		box-shadow: 0rpx 10rpx 50rpx 0rpx rgba(0, 3, 72, 0.1);
		border-radius: 39rpx;
	}

	.login__mode__item {
		height: 77rpx;
		width: 100%;
		line-height: 77rpx;
		text-align: center;
		font-size: 31rpx;
		color: #080808;
		letter-spacing: 1em;
		text-indent: 1em;
		z-index: 2;
		transition: all 0.4s;
	}

	.login__mode__item--active {
		font-weight: bold;
		color: #FFFFFF;
	}

	.login__mode__slider {
		position: absolute;
		height: inherit;
		width: calc(476rpx / 2);
		border-radius: inherit;
		box-shadow: 0rpx 18rpx 72rpx 18rpx rgba(0, 195, 255, 0.1);
		z-index: 1;
		transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
	}

	.login__info {
		margin: 80rpx 30rpx 10rpx 30rpx;
		padding-bottom: 0;
		border-radius: 20rpx;
	}

	.login__info__item__input {
		margin-top: 59rpx;
		width: 100%;
		height: 77rpx;
		border: 1rpx solid #E6E6E6;
		border-radius: 39rpx;
	}

	.login__info__item__input__left-icon {
		width: 10%;
		font-size: 44rpx;
		margin-left: 20rpx;
		color: #838383;
	}

	.login__info__item__input__content {
		width: 80%;
		padding-left: 10rpx;
	}

	.login__info__item__input__content--verify-code {
		width: 56%;
	}

	.login__info__item__input__content input {
		font-size: 24rpx;
	}

	.login__info__item__input__right-icon {
		width: 10%;
		font-size: 44rpx;
		margin-right: 20rpx;
		color: #838383;
	}

	.login__info__item__input__right-verify-code {
		width: 34%;
		margin-right: 20rpx;
	}

	.login__info__item__button {
		margin-top: 75rpx;
		margin-bottom: 39rpx;
		width: 100%;
		height: 77rpx;
		text-align: center;
		font-size: 31rpx;
		font-weight: bold;
		line-height: 77rpx;
		letter-spacing: 1em;
		text-indent: 1em;
		border-radius: 39rpx;
		box-shadow: 1rpx 10rpx 24rpx 0rpx rgba(60, 129, 254, 0.35);
	}

	.login__info__item__tips {
		margin: 30rpx 0;
		color: #AAAAAA;
	}

	.login__way {
		margin: 0 auto;
		margin-top: 110rpx;
	}

	.login__way__item--icon {
		width: 85rpx;
		height: 85rpx;
		font-size: 80rpx;
		margin-bottom: 18rpx;
		position: relative;
		z-index: 1;
	}


	/deep/.input-placeholder {
		font-size: 24rpx;
		color: #838383;
	}
</style>